// Code generated by gen.controlresources.go; DO NOT EDIT.

package {{.Package}}

import (
	"context"
	"fmt"

	"cape-project.eu/sdk-generator/provider/pulumi/internal/schemas"
	"cape-project.eu/sdk-generator/provider/pulumi/internal/utils"
	"github.com/pulumi/pulumi-go-provider/infer"
)

func ({{.Name}}) Update(
	ctx context.Context,
	req infer.UpdateRequest[{{.Name}}Args, {{.Name}}State],
) (infer.UpdateResponse[{{.Name}}State], error) {
	state := req.State
	if req.DryRun {
{{- range .Outputs}}
        {{- if not .Optional }}
        state.{{.Name}} = {{.Type -}} {}
        {{- end}}
{{- end}}
		return infer.UpdateResponse[{{.Name}}State]{
			Output: state,
		}, nil
	}

	tenant := utils.GetTenantFromImputs(ctx, req.State.Metadata)
{{- if not .WithoutWorkspace}}
    workspace, found := utils.GetWorkspaceFromInputs(ctx, req.State.Metadata)
    if !found {
        return infer.UpdateResponse[{{.Name}}State]{}, fmt.Errorf("workspace not given for resource %s", req.State.Metadata.Name)
    }
{{- end}}
	client, err := newAPI(ctx, tenant, {{- if not .WithoutWorkspace}} workspace,{{end}} req.State.Metadata.Name)
	if err != nil {
		return infer.UpdateResponse[{{.Name}}State]{}, err
	}

	exists, err := client.Exists()
	if err != nil {
		return infer.UpdateResponse[{{.Name}}State]{}, err
	}
	if !exists {
		return infer.UpdateResponse[{{.Name}}State]{}, fmt.Errorf("{{.Name}} with name %s does not exists", req.State.Metadata.Name)
	}

	result, err := client.Update(convertArgsToOpenAPI(req.Inputs))
	if err != nil {
		return infer.UpdateResponse[{{.Name}}State]{}, err
	}

	result, err = client.WaitForActive()
	if err != nil {
		return infer.UpdateResponse[{{.Name}}State]{}, err
	}

	return infer.UpdateResponse[{{.Name}}State]{
		Output: convertAPIResultToPulumiState(*result),
	}, nil
}
